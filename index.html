<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AQA Data Integration Pipeline ‚Äî ARPA + ERA5 + Sentinel-5P</title>

<!-- Mermaid.js -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: "default",
    securityLevel: "loose"
  });
</script>

<style>
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    background: #ffffff;
    color: #111827;
    margin: 0;
  }
  header {
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    text-align: center;
    padding: 1.5rem;
  }
  h1 { margin: 0; font-size: 1.9rem; }
  p { color: #64748b; margin: 0.4rem 0 0; }
  .container { max-width: 1100px; margin: 0 auto; padding: 2rem; }
  .mermaid { margin: 30px auto; max-width: 100%; }
</style>
</head>

<body>
  <header>
    <h1>üåç AQA Data Integration Pipeline</h1>
    <p>Interactive Workflow ‚Äî ARPA + ERA5 + Sentinel-5P Integration</p>
  </header>

  <div class="container">
    <div class="mermaid">
flowchart TD
    %% Inputs
    A1["User Configuration<br/>(dates, AOI, pollutants, time windows)"]
    A2["ARPA Lombardia API"]
    A3["ERA5 CDS API"]
    A4["Sentinel-5P Data (via Google Earth Engine)"]

    %% Processing stages
    B1["Load ARPA Metadata<br/>(sensors, coordinates, pollutants)"]
    B2["Download ARPA Measurements<br/>Iterate daily and merge metadata"]
    B3["Download ERA5 Variables<br/>Loop through NetCDF files"]
    B4["Merge ERA5 Files<br/>Combine into single dataset"]
    B5["Build Spatial Grid<br/>Compute minimum sensor distance"]
    B6["Interpolate ERA5 on ARPA Grid<br/>Bilinear interpolation"]
    B7["Compute Period Means<br/>Classify hours as prev / curr"]
    B8["Extract Sentinel-5P Concentrations<br/>(NO2, CO, O3, SO2)"]
    B9["Merge ERA5 + ARPA + Sentinel-5P<br/>Spatial join and enrichment"]
    C1["Integrated Dataset<br/>(ARPA + ERA5 + Sentinel-5P)"]
    C2["Export CSV and GeoDataFrame<br/>Ready for visualization or GEE"]

    %% Flow connections
    A1 --> B1
    B1 --> B2
    A2 --> B2
    A1 --> B3
    A3 --> B3
    B3 --> B4
    B1 --> B5
    B4 --> B6
    B5 --> B6
    B2 --> B7
    B6 --> B9
    B7 --> B9
    A4 --> B8
    B8 --> B9
    B9 --> C1
    C1 --> C2

    %% Styles
    classDef input fill:#dbeafe,stroke:#1e40af,stroke-width:1px,color:#000;
    classDef process fill:#f1f5f9,stroke:#1e293b,stroke-width:1px,color:#000;
    classDef output fill:#dcfce7,stroke:#166534,stroke-width:1px,color:#000;
    class A1,A2,A3,A4 input;
    class B1,B2,B3,B4,B5,B6,B7,B8,B9 process;
    class C1,C2 output;
    </div>
  </div>
</body>
</html>
