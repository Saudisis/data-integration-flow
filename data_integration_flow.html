<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Data Integration Flow ‚Äî AQA Pipeline</title>

<!-- Mermaid -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: "default",
    securityLevel: "loose"
  });
</script>

<style>
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    background: #ffffff;
    color: #111827;
    margin: 0;
  }
  header {
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    text-align: center;
    padding: 1.5rem;
  }
  h1 { margin: 0; font-size: 1.8rem; }
  p { color: #64748b; margin: 0.4rem 0 0; }
  .wrap { max-width: 1100px; margin: 0 auto; padding: 20px; }
  .mermaid { margin: 30px auto; max-width: 100%; }
</style>
</head>

<body>
  <header>
    <h1>üåç Data Integration Flow</h1>
    <p>ARPA + ERA5 Data Harmonization Pipeline</p>
  </header>

  <div class="wrap">
    <div class="mermaid">
flowchart TD
    A1[User Configuration<br/>(cfg: start_date, end_date, time windows, bbox, variables)]
    A2[ARPA Lombardia API]
    A3[ERA5 CDS API]

    B1[Load ARPA Metadata<br/>Sensors ‚Ä¢ Coordinates ‚Ä¢ Pollutants]
    B2[Download ARPA Measurements<br/>Iterate daily ‚Ä¢ Merge with metadata]
    B3[Download ERA5 Variables<br/>Loop through variables (.nc files)]
    B4[Merge ERA5 Files<br/>Combine NetCDF ‚Üí one dataset]
    B5[Build Spatial Grid<br/>Compute min sensor distance ‚Ä¢ generate bounding grid]
    B6[Interpolate ERA5 on ARPA Grid<br/>Bilinear interpolation for each hour]
    B7[Compute Period Means<br/>Classify hours ‚Äúprev‚Äù and ‚Äúcurr‚Äù (12:00‚Äì15:00)]
    B8[Merge ERA5 + ARPA<br/>Nearest join ‚Ä¢ enrich sensors with meteo context]
    C1[Integrated Dataset<br/>(ARPA + ERA5)]
    C2[Summary CSV + GeoDataFrame<br/>Ready for visualization / GEE upload]

    %% Flows
    A1 --> B1
    B1 --> B2
    A2 --> B2
    A1 --> B3
    A3 --> B3
    B3 --> B4
    B1 --> B5
    B4 --> B6
    B5 --> B6
    B2 --> B7
    B6 --> B8
    B7 --> B8
    B8 --> C1
    C1 --> C2

    %% Style
    classDef stage fill:#d1e9ff,stroke:#1e3a8a,stroke-width:1px,color:#000;
    classDef process fill:#f1f5f9,stroke:#1e293b,stroke-width:1px,color:#000;
    classDef output fill:#dcfce7,stroke:#166534,stroke-width:1px,color:#000;
    class A1,A2,A3 stage;
    class B1,B2,B3,B4,B5,B6,B7,B8 process;
    class C1,C2 output;
    </div>
  </div>
</body>
</html>

